name: Discord Log Auto-Updater

on:
  schedule:
    - cron: '0 */12 * * *'  # Runs every 12 hours
  repository_dispatch:
    types: [manual_refresh]  # For your Streamlit button
  workflow_dispatch:         # For manual runs in GitHub UI
    inputs:
      manual_days:
        description: 'Number of days to look back'
        default: '5'
        required: true

jobs:
  update_logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Tools
        run: |
          curl -L https://github.com/Tyrrrz/DiscordChatExporter/releases/latest/download/DiscordChatExporter.Cli.linux-x64.zip -o dce.zip
          unzip dce.zip -d dce && chmod +x dce/DiscordChatExporter.Cli

      - name: Install Pandas
        run: pip install pandas

      - name: Determine Days to Fetch
        id: vars
        run: |
          # Priority: 1. Streamlit Payload | 2. GitHub UI Input | 3. Automatic Default (5 days)
          if [ "${{ github.event.client_payload.hours }}" != "" ]; then
            # Convert Streamlit hours to days for DCE
            DAYS=$(( (${{ github.event.client_payload.hours }} + 23) / 24 ))
            echo "days=$DAYS" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.manual_days }}" != "" ]; then
            echo "days=${{ github.event.inputs.manual_days }}" >> $GITHUB_OUTPUT
          else
            echo "days=5" >> $GITHUB_OUTPUT
          fi

      - name: Get Dropbox Token
        id: dropbox_auth
        run: |
          TOKEN=$(curl -s -X POST https://api.dropbox.com/oauth2/token \
            -u "${{ secrets.DROPBOX_APP_KEY }}:${{ secrets.DROPBOX_APP_SECRET }}" \
            -d grant_type=refresh_token \
            -d refresh_token="${{ secrets.DROPBOX_REFRESH_TOKEN }}" | jq -r '.access_token')
          echo "atoken=$TOKEN" >> $GITHUB_OUTPUT
      - name: Download, Merge & Sort
        run: |
          # 1. Download Master (Existing history)
          curl -L "${{ secrets.DROPBOXLINK }}" -o master_history.csv
          
          # 2. Export Recent (The new slice from Discord)
          ./dce/DiscordChatExporter.Cli export \
            -t "${{ secrets.DISCORD_TOKEN }}" \
            -c ${{ secrets.CHANNEL_ID }} \
            -f Csv -o recent_slice.csv \
            --after $(date -d "${{ steps.vars.outputs.days }} days ago" +%Y-%m-%d)

          # 3. Corrected Positional Merge
          python3 -c "
          import pandas as pd
          import os

          try:
              # Load Master and New Slice
              # Using header=None because your CSV is headerless
              h = pd.read_csv('master_history.csv', dtype=str, header=None)
              a = pd.read_csv('recent_slice.csv', dtype=str, header=None)
              
              print(f'Original Master: {len(h)} rows')
              print(f'New Slice: {len(a)} rows')

              # Combine them
              combined = pd.concat([h, a], ignore_index=True)

              # DEDUPLICATE: Use Time (Col 2) and Message (Col 3) as the unique key
              # This prevents duplicates without needing a Message ID
              final = combined.drop_duplicates(subset=[2, 3], keep='first')

              # CLEANUP: Ensure Column 2 is datetime so sorting works
              final[2] = pd.to_datetime(final[2], errors='coerce')
              final = final.dropna(subset=[2]) # Remove any rows with corrupt timestamps
              
              # SORT: Put the newest messages at the bottom
              final = final.sort_values(by=2, ascending=True)

              # SAVE: Write back to CSV with NO header
              final.to_csv('updated_master.csv', index=False, header=False)
              print(f'Final Merged Count: {len(final)} rows')

          except Exception as e:
              print(f'CRITICAL ERROR during merge: {e}')
              exit(1)
          "
